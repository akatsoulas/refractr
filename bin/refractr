#!/usr/bin/env python3
import os
import sys

from argparse import ArgumentParser
from leatherman.yaml import yaml_print
from leatherman.dbg import dbg

OUTPUT = ["echo", "file"]

DIR = os.path.abspath(os.path.dirname(__file__) + "/..")
CWD = os.path.abspath(os.getcwd())
REL = os.path.relpath(DIR, CWD)
SRC = f"{DIR}/src"

sys.path.insert(0, SRC)

from refractr import load_refractr

def main(args):
    parser = ArgumentParser()
    parser.add_argument(
        "-c",
        "--config",
        metavar="CFG",
        default=f"{REL}/refractr.yml",
        help='default="%(default)s"; specify the config yaml to use',
    )
    parser.add_argument(
        "-o",
        "--output",
        metavar="OUT",
        default=OUTPUT[0],
        choices=OUTPUT,
        help='default="%(default)s"; specify one of %(choices)s',
    )
    parser.add_argument(
        '-l',
        '--load-only',
        action='store_true',
        help='default="%(default)s"; toggle load-only option'
    )
    parser.add_argument(
        '-v',
        '--validate-only',
        action='store_true',
        help='default="%(default)s"; toggle validate-only option'
    )
    parser.add_argument(
        '-s',
        '--sources-only',
        action='store_true',
        help='default="%(default)s"; toggle sources-only option'
    )
    parser.add_argument(
        "refractr_pns",
        nargs="*",
        default=["*"],
        help='default="%(default)s"; patterns to limit refracts',
    )
    ns = parser.parse_args(args)
    refractr = load_refractr(**ns.__dict__)
    if ns.validate_only:
        yaml_print(refractr.validate())
    elif ns.sources_only:
        yaml_print(refractr.sources())
    elif ns.load_only:
        print(refractr)
    else:
        print(refractr.render())

if __name__ == '__main__':
    main(sys.argv[1:])
